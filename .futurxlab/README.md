# Zone Clock Architecture Documentation

## 项目概述
Zone Clock（专注力管理助手）的完整架构文档，基于**业务逻辑守恒原理**生成。

## 业务逻辑守恒原理

### 核心理论
```
业务逻辑 = 常量（守恒）
完整系统 = 业务逻辑 × 视图展现

其中：
- 业务逻辑是不变的"质量"
- 视图展现是可转换的"形式"
```

### 守恒验证
本架构确保以下等式成立：
```
Info(用户旅程) = Info(时序图) = Info(状态图) = Info(API) = 业务逻辑
```

## 架构文档结构

### 📁 文档清单
- `user-journey.md` - 用户旅程图（Mermaid）
- `sequence-diagram.md` - 时序交互图（Mermaid）
- `state-diagram.md` - 状态机图（Mermaid）
- `api-spec.yaml` - OpenAPI 3.0 规范
- `README.md` - 架构总览（本文档）

## 核心业务逻辑提取

### 1. 专注管理逻辑
- **90分钟专注周期**: 核心工作单元
- **2-5分钟随机微休息**: 保持专注力的关键机制
- **10秒微休息时长**: 固定的休息间隔
- **20分钟大休息**: 周期间的恢复时间

### 2. 状态转换逻辑
```
未初始化 → 就绪 → 专注中 ⟷ 大休息中
              ↑_______|
```

### 3. 数据一致性逻辑
- 本地状态 + 同步差异 = 云端状态
- 版本冲突 → 最新版本优先

## 完整映射矩阵

### 用户动作 → API调用 → 状态转换 → 时序交互

| 用户动作 | API调用 | 状态转换 | 时序图块 | 引用标记 |
|---------|---------|---------|----------|----------|
| 点击开始 | POST /api/cycles/start | 就绪→专注中 | Rectangle 1 | #REF-UJ-1 |
| 自动微休息 | POST /api/breaks/micro/trigger | 活跃→微休息中 | Rectangle 2 | #REF-UJ-2 |
| 暂停/恢复 | PUT /api/cycles/{id}/pause\|resume | 活跃⟷暂停 | Rectangle 3 | #REF-UJ-3 |
| 完成周期 | POST /api/breaks/long/start | 专注中→大休息中 | Rectangle 4 | #REF-UJ-4 |
| 修改设置 | PUT /api/settings/* | 配置模式内转换 | Rectangle 5 | #REF-UJ-5 |
| 查看统计 | GET /api/statistics/* | 进入统计查看 | Rectangle 6 | #REF-UJ-6 |
| 数据同步 | POST /api/sync/trigger | 进入数据同步 | Rectangle 7 | #REF-UJ-7 |

### API → 系统组件映射

| API端点 | 触发组件 | 状态管理 | 数据存储 | 通知服务 |
|---------|---------|---------|---------|----------|
| /api/cycles/start | 计时控制器 | ✓ | ✓ | - |
| /api/breaks/micro/trigger | 计时控制器 | ✓ | ✓ | ✓ |
| /api/cycles/{id}/pause | 计时控制器 | ✓ | ✓ | - |
| /api/breaks/long/start | 计时控制器 | ✓ | ✓ | ✓ |
| /api/settings/* | - | ✓ | ✓ | - |
| /api/statistics/* | - | - | ✓ | - |
| /api/sync/trigger | 同步服务 | ✓ | ✓ | - |

## 双向可追溯性验证

### ✅ 正向追溯（用户旅程 → API）
- 每个用户动作都有对应的API调用
- 每个决策点都映射到具体的API操作
- 系统自动行为也通过API记录

### ✅ 反向追溯（API → 用户旅程）
- 每个API都对应明确的业务场景
- 每个API响应都影响用户界面状态
- 没有孤立的API端点

### ✅ 横向追溯（状态 ⟷ 时序）
- 每个状态转换对应时序图中的交互
- 时序图的每个Rectangle对应一个状态机阶段
- 并行处理（par）对应并发状态

## 业务规则提取

### 时间约束规则
```yaml
专注时长: [15, 180] # 分钟
休息时长: [5, 60]   # 分钟
微休息间隔: [2, 5]  # 分钟（随机）
微休息时长: 10      # 秒（固定）
```

### 状态互斥规则
- 不能同时处于专注和休息状态
- 暂停状态下不触发微休息
- 勿扰模式下暂停所有通知

### 数据同步规则
- 本地版本 > 远程版本 → 上传
- 远程版本 > 本地版本 → 下载
- 版本冲突 → 保留最新

## 关键设计决策

### 1. 为什么使用随机微休息间隔？
**守恒原理**: 保持专注力的总量不变，通过随机性防止用户预期，维持注意力张力。

### 2. 为什么微休息固定10秒？
**守恒原理**: 休息效果与时长非线性相关，10秒足够打断疲劳累积，又不会破坏工作状态。

### 3. 为什么采用手动开始新周期？
**守恒原理**: 用户意愿是启动专注的必要条件，自动开始会破坏专注质量守恒。

## 验证检查表

### 完整性验证 ✅
- [x] 所有用户故事都有对应实现
- [x] 所有API都有业务意义
- [x] 所有状态都可达且可退出
- [x] 所有交互都有明确的时序

### 一致性验证 ✅
- [x] API命名规范一致
- [x] 状态转换逻辑无冲突
- [x] 时序图消息与API对应
- [x] 错误处理机制完备

### 可追溯性验证 ✅
- [x] 需求→设计可追溯
- [x] 设计→实现可映射
- [x] 变更影响可分析
- [x] 测试覆盖可验证

## 使用指南

### 查看用户旅程
```bash
# 理解用户如何使用系统
cat user-journey.md
```

### 查看交互时序
```bash
# 理解系统组件如何协作
cat sequence-diagram.md
```

### 查看状态机
```bash
# 理解系统状态如何转换
cat state-diagram.md
```

### 查看API规范
```bash
# 理解接口定义和数据模型
cat api-spec.yaml
```

### 验证守恒原理
```bash
# 检查任意视图是否能推导出其他视图
# 例如：从API规范推导用户旅程
grep "POST /api/cycles/start" api-spec.yaml
grep "开始专注" user-journey.md
# 应该能找到对应关系
```

## 变更管理指南

### 添加新功能时
1. 先更新用户旅程（用户视角）
2. 设计API接口（实现视角）
3. 更新状态图（状态视角）
4. 补充时序图（交互视角）
5. 验证守恒原理仍然成立

### 修改现有功能时
1. 识别影响范围（通过映射矩阵）
2. 同步更新所有相关视图
3. 确保引用标记（#REF-*）一致
4. 重新验证双向可追溯性

## 技术债务记录

### 当前限制
1. iOS后台执行限制 → 使用本地通知替代
2. 音频格式限制 → 仅支持mp3/wav/aiff/m4a
3. iCloud存储配额 → 需要数据压缩策略

### 未来优化
1. [ ] 支持团队协作模式
2. [ ] 集成第三方日历
3. [ ] AI驱动的专注建议
4. [ ] 多平台扩展（Android/Web）

## 总结

本架构文档完整实现了**业务逻辑守恒原理**：
- **完整性**: 所有业务需求都有对应设计
- **一致性**: 所有视图描述同一业务逻辑
- **可追溯性**: 任意视图可互相推导
- **可维护性**: 变更影响清晰可控

---
*Generated with Business Logic Conservation Principle*
*Version: 1.0.1 | Date: 2025-01-22*
*By: Joey - AI Unified Architect*