# State Diagram - Zone Clock

## System State Machine

```mermaid
stateDiagram-v2
    [*] --> 未初始化: 应用启动

    未初始化 --> 初始化中: 检查权限
    初始化中 --> 就绪: 权限授予 [API: POST /api/users/onboarding]
    初始化中 --> 需要授权: 权限拒绝

    需要授权 --> 就绪: 用户授权

    就绪 --> 专注中: 开始专注 [API: POST /api/cycles/start]

    state 专注中 {
        [*] --> 活跃专注
        活跃专注 --> 微休息中: 随机触发(2-5分钟) [API: POST /api/breaks/micro/trigger]
        微休息中 --> 活跃专注: 10秒结束
        活跃专注 --> 已暂停: 用户暂停 [API: PUT /api/cycles/{id}/pause]
        已暂停 --> 活跃专注: 用户恢复 [API: PUT /api/cycles/{id}/resume]

        state 微休息中 {
            [*] --> 倒计时10秒
            倒计时10秒 --> 播放提示音: entry
            播放提示音 --> 显示休息UI
            显示休息UI --> 倒计时更新: 每秒
            倒计时更新 --> 倒计时更新: 秒数>0
            倒计时更新 --> [*]: 秒数=0
        }
    }

    专注中 --> 大休息中: 90分钟完成 [API: POST /api/breaks/long/start]
    专注中 --> 就绪: 用户停止 [API: PUT /api/cycles/{id}/stop]

    state 大休息中 {
        [*] --> 休息倒计时
        休息倒计时 --> 显示统计: 并行 [API: GET /api/statistics/cycle/{id}]
        休息倒计时 --> 休息提醒: 20分钟结束
        休息提醒 --> [*]
    }

    大休息中 --> 就绪: 休息完成/用户跳过

    state 配置模式 {
        [*] --> 查看设置: [API: GET /api/settings]
        查看设置 --> 修改专注时长: 用户操作 [API: PUT /api/settings/focus-duration]
        查看设置 --> 修改休息时长: 用户操作 [API: PUT /api/settings/break-duration]
        查看设置 --> 配置提示音: 用户操作 [API: PUT /api/settings/sounds]
        查看设置 --> 切换勿扰: 用户操作 [API: PUT /api/settings/dnd]
        修改专注时长 --> 验证输入: 15-180分钟
        修改休息时长 --> 验证输入: 5-60分钟
        配置提示音 --> 音频预览
        验证输入 --> 保存成功: 有效
        验证输入 --> 错误提示: 无效
        错误提示 --> 查看设置
        保存成功 --> 查看设置
        音频预览 --> 查看设置
        切换勿扰 --> 查看设置
    }

    就绪 --> 配置模式: 进入设置
    配置模式 --> 就绪: 退出设置
    专注中 --> 配置模式: 快速设置
    配置模式 --> 专注中: 返回专注

    state 勿扰模式 {
        [*] --> 勿扰激活
        勿扰激活 --> 通知暂停: [API: PUT /api/settings/dnd]
        通知暂停 --> 静音运行
        静音运行 --> 解除勿扰: 用户关闭
        解除勿扰 --> [*]
    }

    就绪 --> 勿扰模式: 开启勿扰
    专注中 --> 勿扰模式: 开启勿扰
    勿扰模式 --> 就绪: 关闭勿扰
    勿扰模式 --> 专注中: 继续专注

    state 数据同步 {
        [*] --> 检查连接
        检查连接 --> 比较版本: 有网络
        检查连接 --> 缓存待同步: 无网络
        比较版本 --> 上传数据: 本地较新
        比较版本 --> 下载数据: 远程较新
        比较版本 --> 解决冲突: 版本冲突
        上传数据 --> 同步成功: [API: POST /api/sync/trigger]
        下载数据 --> 同步成功
        解决冲突 --> 合并数据
        合并数据 --> 同步成功
        缓存待同步 --> 等待重试
        等待重试 --> 检查连接: 定时/手动
        同步成功 --> [*]
    }

    %% 任何状态都可以触发同步
    就绪 --> 数据同步: 触发同步
    专注中 --> 数据同步: 后台同步
    大休息中 --> 数据同步: 自动同步
    数据同步 --> 就绪: 同步完成
    数据同步 --> 专注中: 继续专注
    数据同步 --> 大休息中: 继续休息

    state 统计查看 {
        [*] --> 加载数据
        加载数据 --> 今日统计: [API: GET /api/statistics/today]
        加载数据 --> 历史记录: [API: GET /api/statistics/history]
        加载数据 --> 趋势分析: [API: GET /api/statistics/trends]
        今日统计 --> 渲染图表
        历史记录 --> 渲染列表
        趋势分析 --> 渲染图表
        渲染图表 --> 显示完成
        渲染列表 --> 显示完成
        显示完成 --> [*]
    }

    就绪 --> 统计查看: 查看统计
    大休息中 --> 统计查看: 查看本轮
    统计查看 --> 就绪: 关闭统计
    统计查看 --> 大休息中: 返回休息
```

## State Transition Rules

### 核心状态转换映射

| 起始状态 | 触发条件 | API调用 | 目标状态 |
|---------|---------|---------|---------|
| 就绪 | 用户点击开始 | POST /api/cycles/start | 专注中 |
| 活跃专注 | 随机2-5分钟 | POST /api/breaks/micro/trigger | 微休息中 |
| 微休息中 | 10秒结束 | 自动 | 活跃专注 |
| 活跃专注 | 用户暂停 | PUT /api/cycles/{id}/pause | 已暂停 |
| 已暂停 | 用户恢复 | PUT /api/cycles/{id}/resume | 活跃专注 |
| 专注中 | 90分钟完成 | POST /api/breaks/long/start | 大休息中 |
| 大休息中 | 20分钟结束 | 自动 | 就绪 |
| 任何状态 | 进入设置 | GET /api/settings | 配置模式 |
| 任何状态 | 开启勿扰 | PUT /api/settings/dnd | 勿扰模式 |
| 任何状态 | 触发同步 | POST /api/sync/trigger | 数据同步 |

### 状态不变量（守恒规则）

1. **专注状态守恒**: 专注中的子状态（活跃/暂停/微休息）总时长 = 设定的专注时长
2. **休息状态守恒**: 微休息次数 × 10秒 + 大休息时长 = 总休息时长
3. **数据一致性守恒**: 本地状态 + 同步差异 = 云端状态
4. **设置生效守恒**: 当前设置 + 修改项 = 新设置（下轮生效）

## Cross-Reference Mappings

### 状态与用户旅程映射
- **就绪** ← #REF-UJ-1 (用户选择开始)
- **专注中** ← #REF-UJ-2 (微休息循环)
- **已暂停** ← #REF-UJ-3 (暂停决策)
- **大休息中** ← #REF-UJ-4 (周期完成)
- **配置模式** ← #REF-UJ-5 (个性化配置)
- **统计查看** ← #REF-UJ-6 (数据查看)
- **数据同步** ← #REF-UJ-7 (跨设备同步)

### 状态与时序图映射
- 每个状态转换对应时序图中的一个Rectangle块
- 状态内的活动对应时序图中的消息交互
- 并行状态对应时序图中的par块
- 条件转换对应时序图中的alt块

## Business Logic Conservation Verification
- ✓ 所有用户动作都有对应的状态转换
- ✓ 所有状态转换都绑定了API调用
- ✓ 状态机完整覆盖了业务需求中的所有场景
- ✓ 没有孤立状态，所有状态都可达且可退出